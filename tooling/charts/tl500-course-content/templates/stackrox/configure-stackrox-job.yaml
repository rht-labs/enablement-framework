---
apiVersion: batch/v1
kind: Job
metadata:
  name: configure-stackrox-integration
  namespace: {{ index .Values "stackrox-chart" "stackrox" "namespace" | quote }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "3"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      containers:
        - image: quay.io/rht-labs/stack-tl500:latest
          command:
            - /bin/bash
            - -c
            - |
              test {{ .Values.verbose | default "false" }} == true && set -x

              # â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              STACKROX_NS="{{ index .Values "stackrox-chart" "stackrox" "namespace" }}"
              CLUSTER_DOMAIN="{{ .Values.cluster_domain }}"
              REGISTRY_ENDPOINT="image-registry.openshift-image-registry.svc:5000"

              # â”€â”€ Step 1: Wait for StackRox Operator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              echo "â³ [1/5] Waiting for StackRox operator CRD..."
              while [ true ]; do oc get crd centrals.platform.stackrox.io; if [ $? -eq 0 ]; then break; fi ; sleep 5s; done
              echo "âœ… [1/5] StackRox CRD available"

              # â”€â”€ Step 2: Wait for Central pods â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              echo "â³ [2/5] Waiting for Central pods..."
              while test 0 == $(oc -n ${STACKROX_NS} get pod -l app.kubernetes.io/component=central -o name 2>/dev/null | wc -l); do sleep 5; done
              oc -n ${STACKROX_NS} wait pod -l app.kubernetes.io/component=central --for=condition=Ready --timeout=200s
              if [ $? != 0 ]; then
                echo "ğŸ›‘ [2/5] Timed out waiting for Central pods";
                exit 1;
              fi
              echo "âœ… [2/5] Central pods ready"
              sleep 15;

              # â”€â”€ Step 3: Get StackRox credentials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              echo "â³ [3/5] Retrieving StackRox admin credentials..."
              ROX_ENDPOINT="central-${STACKROX_NS}.${CLUSTER_DOMAIN}"
              ROX_ADMIN_PASSWD=$(oc -n ${STACKROX_NS} get secret central-htpasswd -o jsonpath='{.data.password}' | base64 --decode)
              echo "âœ… [3/5] Credentials retrieved"

              # â”€â”€ Step 4: Wait for pipeline ServiceAccount â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              echo "â³ [4/5] Waiting for tl500 pipeline ServiceAccount..."
              while test 0 == $(oc -n tl500 get sa/pipeline -o name 2>/dev/null | wc -l); do sleep 5; done
              echo "âœ… [4/5] Pipeline ServiceAccount found"

              # â”€â”€ Step 5: Configure registry integration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              echo "â³ [5/5] Creating token and configuring StackRox registry integration..."
              TOKEN=$(oc create token pipeline -n tl500 --duration=8760h)
              PAYLOAD=$(cat <<EOF
              {
                "id": "",
                "name": "tl500 - OCP internal registry",
                "categories": ["REGISTRY"],
                "docker": {
                  "endpoint": "${REGISTRY_ENDPOINT}",
                  "username": "pipeline",
                  "password": "${TOKEN}",
                  "insecure": true
                },
                "autogenerated": false,
                "clusterId": "",
                "clusters": [],
                "skipTestIntegration": false,
                "type": "docker"
              }
              EOF
              )
              RET=$(curl -sk -u "admin:${ROX_ADMIN_PASSWD}" "https://${ROX_ENDPOINT}/v1/imageintegrations" -d "$PAYLOAD" | jq .error)
              if [[ ${RET} != "null" && ! -z ${RET} ]]; then
                echo "ğŸ›‘ [5/5] Failed to set image integration: ${RET}";
                exit 1;
              fi
              echo "âœ… [5/5] Registry integration configured successfully"
              echo "ğŸ‰ StackRox configuration complete!"
              exit 0;
          imagePullPolicy: Always
          name: configure-stackrox-integration
      dnsPolicy: ClusterFirst
      restartPolicy: OnFailure
      serviceAccount: configure-stackrox-integration
      serviceAccountName: configure-stackrox-integration
      terminationGracePeriodSeconds: 10
